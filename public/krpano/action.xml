<krpano>
    <action name="getUrl" type="javascript">
        console.log("spot_id:"+krpano.spot_id);
        var spotId=krpano.spot_id;
        console.log("hlookat:"+krpano.view.hlookat);
        var hlookat=krpano.view.hlookat;
        console.log("vlookat:"+krpano.view.vlookat);
        var vlookat=krpano.view.vlookat;
        console.log("canvasId:"+caller.canvas_id);
        var canvasId=caller.canvas_id;
        urlStr="/editor?spotId="+spotId+"&#38;canvasId="+canvasId+"&#38;hlookat="+hlookat+"&#38;vlookat="+vlookat;
        console.log("urlStr:"+urlStr);
        window.location.href = urlStr;
        <!-- actions.openurl("http://www.google.com", _self); -->
    </action>

    <action name="set_tool" type="javascript">
        if(krpano.tipCoin==0){
        var fontScale=caller.scale;
        krpano.layer.getItem('tooltip_text').html=caller.name;
        krpano.layer.getItem('tooltip_text').visible=true;
        krpano.layer.getItem('tooltip_text').css="font-family:Arial; font-size:20px; color:#ffffff;"
        var x1;
        var y1;
        var coord=krpano.spheretoscreen(caller.ath,caller.atv);
        <!-- console.log(coord.x,+":",); -->
        <!-- console.log("y:"+callery+20); -->
        krpano.layer.getItem('tooltip_text').x=coord.x;
        krpano.layer.getItem('tooltip_text').y=coord.y-10;
        krpano.tipCoin=1;
        }else {
        krpano.layer.getItem('tooltip_text').visible=false;
        krpano.layer.getItem('tooltip_text').html="";
        krpano.tipCoin=0;
        }
        <!-- console.log(krpano.tipCoin); -->

    </action>

    <action name="initiate" scope="global" type="javascript">
        krpano.tipCoin=0;
        krpano.addlayer("tooltip_text");
        krpano.layer.getItem('tooltip_text').type="text";
        krpano.layer.getItem('tooltip_text').edge="bottom";
        krpano.layer.getItem('tooltip_text').x=0;
        krpano.layer.getItem('tooltip_text').y=0;
        krpano.layer.getItem('tooltip_text').html="";
        krpano.layer.getItem('tooltip_text').visible=false;
        krpano.layer.getItem('tooltip_text').css="font-family:Arial; font-size:50px; color:#ffffff;";
        krpano.layer.getItem('tooltip_text').bgalpha="0";


        var spots=krpano.hotspot.getArray();

        spots.forEach(function(spot){
        if(spot.hotspot_type=="navigation"){
        spot.onover="set_tool";
        spot.onout="set_tool";
        }

        });
        <!-- console.log(krpano.hotspot.count); -->

    </action>


    <action name="setupSurface" type="javascript">

        var coin=caller.coin;
        <!-- 因為只要image重新lode，就會再執行一次onloaded。
            所以我們要用coin的判斷是不是這個action已經執行過了。
            若執行過就不再執行一次。
            -->
        if (coin=="0"){
        if ((args[1]=='main')){
        console.log('main');
        caller.url=caller.url_main;
        var scale_shared=caller.scale;
        var main_w=caller.main_w;
        var main_h=caller.main_h;
        var shared_w=caller.shared_w;
        var shared_h=caller.shared_h;
        var select=caller.select;
        var scale_main;
        if (select=="w") {
        scale_main=scale_shared*(shared_w/main_w);
        }else {
        scale_main=scale_shared*(shared_h/main_h);
        }
        console.log(scale_main);
        caller.ox=parseFloat(caller.ox)+parseFloat(caller.ox_offset);
        caller.oy=parseFloat(caller.oy)+parseFloat(caller.oy_offset);
        caller.scale=scale_main;
        caller.coin=1;
        }else if ((args[1]=='live')){
        var scale_shared=caller.scale;
        var main_w=caller.main_w;
        var main_h=caller.main_h;
        var shared_w=caller.shared_w;
        var shared_h=caller.shared_h;
        var select=caller.select;
        var scale_main;
        if (select=="w") {
        scale_main=scale_shared*(shared_w/main_w);
        }else {
        scale_main=scale_shared*(shared_h/main_h);
        }
        console.log(scale_main);
        caller.ox=parseFloat(caller.ox)+parseFloat(caller.ox_offset);
        caller.oy=parseFloat(caller.oy)+parseFloat(caller.oy_offset);
        caller.scale=scale_main;
        caller.coin=1;

        }else if(args[1]=='shared') {
        console.log('shared');
        caller.url=caller.url_shared;
        caller.coin=1;
        }
        }
    </action>

    <action name="NavigateTo" type="javascript">
        var url=caller.goto_url;
        var hlookat=caller.hlookat;
        var vlookat=caller.vlookat;
        url=url+"?hlookat="+hlookat+"&#38;vlookat="+vlookat ;
        console.log("url:"+url);
        window.location.href = url;
    </action>


    <!-- view settings -->
    <action name="do_crop_animation" scope="local" args="framewidth, frameheight, framerate">
        <!-- define local variables -->
        calc(local.xframes, (caller.imagewidth /framewidth) BOR 0);
        calc(local.frames, xframes * ((caller.imageheight / frameheight) BOR 0));
        def(local.frame, integer, 0);

        <!-- set the first frame -->
        calc(caller.crop, '0|0|' + framewidth + '|' + frameheight);

        <!-- do the animation -->
        setinterval(calc('crop_anim_' + caller.name), calc(150.0 / framerate),
        if(caller.loaded,
        inc(frame);
        if(frame GE frames, if(caller.onlastframe !== null, callwith(caller, onlastframe() ) ); set(frame,0); );
        mod(xpos, frame, xframes);
        div(ypos, frame, xframes);
        Math.floor(ypos);
        mul(xpos, framewidth);
        mul(ypos, frameheight);
        calc(caller.crop, xpos + '|' + ypos + '|' + framewidth + '|' + frameheight);
        ,
        <!-- stop the interval when the hotspot gets removed -->
        clearinterval(calc('crop_anim_' + caller.name));
        );
        );
    </action>

    <action name="hideNav" type="javascript" scope="global">

        var hotspotArr= krpano.hotspot;
        var count=hotspotArr.count;
        console.log(count);
        var i=0;

        <!-- console.log(hotspotArr.getArray()); -->
        for (x in hotspotArr.getArray()){

        var type=hotspotArr.getItem(i).hotspot_type;
        if (type=="navigation"){
        console.log(hotspotArr.getItem(i).name);
        hotspotArr.getItem(i).enabled=false;
        hotspotArr.getItem(i).alpha=0;

        }

        i++;
        }


    </action>


    <action name="addHashToNav" type="javascript" scope="local" args="hash">

        var hotspotArr= krpano.hotspot;
        var layerArr= krpano.layer;
        var count=hotspotArr.count;
        var count2=layerArr.count;
        console.log('nara',count2);
        var i=0;
        <!-- console.log(hotspotArr.getArray()); -->
        for (x in hotspotArr.getArray()){
        var type=hotspotArr.getItem(i).hotspot_type;
        var style=hotspotArr.getItem(i).style;
        if (type=="navigation"){
        console.log(hotspotArr.getItem(i).name);

        clickStr=hotspotArr.getItem(i).onclick;
        console.log(clickStr);
        var strArr=clickStr.split("?");
        console.log(strArr[0]);
        var str1Arr=strArr[0].split("/");
        var newSpotId=str1Arr[str1Arr.length-1]
        var clickStr="openurl('/share/link/"+hash+"/"+newSpotId+"?"+strArr[1];
        console.log(clickStr);
        hotspotArr.getItem(i).onclick=clickStr;
        }
        if (style=="surface_click"){
        hotspotArr.getItem(i).enabled=false;
        }
        i++;
        }

        i=0;
        for (x in layerArr.getArray()){
        var type=layerArr.getItem(i).layer_type;
        console.log('nara_test',type);
        if (type=="map_pin"){
        console.log(layerArr.getItem(i).name);
        console.log(strArr[1])
        var clickStr=layerArr.getItem(i).onclick;
        var splitStrArr=clickStr.split("?");
        var str1Arr=splitStrArr[0].split("/");
        var newSpotId=str1Arr[str1Arr.length-1].split("'")[0]
        console.log(newSpotId, "Spot id")
        var clickStr="openurl('/share/link/"+hash+"/"+newSpotId+"?"+strArr[1];
        layerArr.getItem(i).onclick=clickStr;
        }
        if (style=="surface_click"){
        layerArr.getItem(i).enabled=true;
        }
        i++;
        }


    </action>


    <action name="hideEditBtn">

        set(layer['version'].visible,false);
        set(layer['guide'].visible,false);


    </action>

    <action name="hideMap">
        set(layer['main_map'].visible,false);
    </action>

    <action name="scaleMaptoScreen">
        set (layer['map_bg'].scale,%1);
    </action>

    <action name="moveLogout30">
        set(layer['logout'].x,30);
    </action>

    <action name="moveLogout120">
        set(layer['logout'].x,120);
    </action>


</krpano>
